<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>현재 밀집도</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" type="text/css">
    <link href="/static/css/index.css" rel="stylesheet">
</head>
<body onload="initTmap();">
    <div class="app-container">
        <div class="header">
            <h5 id="loc_main" class="loc_main mb-0">위치 정보 확인중</h5>
        </div>
        <div class="content">
            <p id="density_title" class="mb-1 mt-2">현재 밀집도</p>
            <p id="density_val" class="mb-0">50%</p>
            <p id="density_stage" class="status mt-0"></p>
            <p id="server_date" class="date_time mb-1"></p>
            <p id="server_time" class="date_time mb-3"></p>
            <p id="status" class="date_time mb-1"></p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="/static/js/jihoon.js"></script>
    <script src="/static/js/hamin.js"></script>
    <script>
        const key = h_config.apikey;
        const MAX_CONGESTION = 0.4; // 최대 혼잡도 0.4명/㎡

        function loadTMapScript(key) {
            $.ajax({
                url: 'https://apis.openapi.sk.com/tmap/jsv2',
                data: {
                    version: '1',
                    appKey: key
                },
                dataType: 'script',
                success: function() {
                    console.log('로드 완료');
                },
                error: function(jqxhr, settings, exception) {
                    console.error('TMap JavaScript API 로드 실패', exception);
                }
            });
        }

        loadTMapScript(key);

        function sendLocation(latitude, longitude) {
            var currentLat = latitude;
            var currentLon = longitude;

            var latElement = document.getElementById('latitude');
            var lonElement = document.getElementById('longitude');

            if (latElement && lonElement) {
                latElement.textContent = "Latitude: " + currentLat;
                lonElement.textContent = "Longitude: " + currentLon;
            } else {
                console.log("위치 정보를 확인할 수 없습니다.");
            }

            reverseLabel(currentLon, currentLat);
        }

        function initTmap() {
            getCurrentLocation();
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showCurrentLocation, locationError);
            } else {
                console.log("Geolocation is not supported by this browser.");
                const defaultLat = 37.5665;  
                const defaultLon = 126.9780;
                sendLocation(defaultLat, defaultLon);
            }
        }

        function showCurrentLocation(position) {
            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            
            console.log("Current Location: " + currentLat + ", " + currentLon);

            reverseLabel(currentLon, currentLat);
        }

        function locationError(error) {
            console.warn(`ERROR(${error.code}): ${error.message}`);
        }

        function reverseLabel(currentLon, currentLat) {
            $.ajax({
                method: "GET",
                url: "https://apis.openapi.sk.com/tmap/geo/reverseLabel?version=1&format=json",
                data: {
                    "reqLevel": 15,
                    "centerLon": currentLon,
                    "centerLat": currentLat,
                    "reqCoordType": "WGS84GEO",
                    "resCoordType": "WGS84GEO",
                    "appKey": key
                },
                success: function(response) {
                    const resultInfo = response.poiInfo;
                    if (resultInfo) {
                        const { poiLon: lon, poiLat: lat, id: poiId, name } = resultInfo;
                        const url = `https://apis.openapi.sk.com/tmap/puzzle/pois/${poiId}?format=json&appKey=${key}&lat=${currentLat}&lng=${currentLon}`;
                        puzzle(url, name);
                    } else {
                        console.log("위치 정보를 찾을 수 없습니다.");
                    }
                },
                error: function(request, status, error) {
                    console.log("code:" + request.status + "\nmessage:" + request.responseText + "\nerror:" + error);
                }
            });
        }

        function puzzle(url, name) {
            $.ajax({
                method: "GET",
                url: url,
                success: function(response) {
                    console.log(response);
                    
                    const parts = response.contents.poiName;
                    const buildingName = parts;
                    const rltm = response.contents.rltm;

                    if (rltm && rltm.length > 0) {
                        const data = rltm.find(item => item.type === 2);
                        if (data) {
                            const { congestion, congestionLevel, datetime } = data;
                            const densityPercentage = ((congestion / MAX_CONGESTION) * 100).toFixed(2); // 혼잡도 백분율 계산
                            const congestText = congestionLevelText(congestionLevel); // 혼잡도 단계는 API 값을 사용
                            const statusText = statusLevelText(congestionLevel); // 상태 메시지 설정
                            const dateStr = formatDate(datetime);
                            
                            let year = datetime.substr(0, 4);
                            let month = datetime.substr(4, 2);
                            let day = datetime.substr(6, 2);

                            let hour = parseInt(datetime.substr(8, 2));
                            let min = datetime.substr(10, 2);
                            let period = "AM";

                            if (hour >= 12) {
                                period = "PM";
                                if (hour > 12) {
                                    hour -= 12;
                                }
                            } else if (hour === 0) {
                                hour = 12;
                            }

                            let hourStr = hour.toString().padStart(2, '0');
                            let date = `${year}년 ${month}월 ${day}일`;
                            let time = `${hourStr}:${min} ${period}`;

                            const result = `${name}, [${congestText}, ${densityPercentage}%], ${dateStr}`;
                            
                            $("#loc_main").text(buildingName);

                            console.log(buildingName);
                            console.log(date);  

                            $('#server_date').text(date);
                            $('#server_time').text(time);
                            $('#density_val').text(`${densityPercentage}%`);
                            $('#density_stage').text(congestText);
                            $('#status').text(statusText); // 상태 메시지 설정

                            const stageElement = document.getElementById('density_stage');
                            switch(congestText) {
                                case "여유":
                                    stageElement.style.color = 'blue';
                                    break;
                                case "보통":
                                    stageElement.style.color = 'green';
                                    break;
                                case "혼잡":
                                    stageElement.style.color = 'orange';
                                    break;
                                case "매우 혼잡":
                                    stageElement.style.color = 'red';
                                    break;
                                default:
                                    stageElement.style.color = 'black';
                                    break;
                            }

                            const statusElement = document.getElementById('status');
                            statusElement.classList.remove('blink'); // 기존 깜빡임 효과 제거
                            switch(statusText) {
                                case "안전합니다":
                                    statusElement.style.color = 'blue';
                                    break;
                                case "보통입니다":
                                    statusElement.style.color = 'green';
                                    break;
                                case "주의하세요":
                                    statusElement.style.color = 'orange';
                                    break;
                                case "위험합니다":
                                    statusElement.style.color = 'red';
                                    statusElement.classList.add('blink'); // 깜빡임 효과 추가
                                    break;
                                default:
                                    statusElement.style.color = 'black';
                                    break;
                            }

                        } else {
                            console.log(`해당 위치는 실시간 장소 혼잡도를 지원하고 있지 않습니다.`);
                        }
                    } else {
                        console.log(`해당 위치는 실시간 장소 혼잡도를 지원하고 있지 않습니다.`);
                    }
                },
                error: function(request, status, error) {
                    console.log("code:" + request.status + "\nmessage:" + request.responseText + "\nerror:" + error);
                }
            });
        }

        function formatDate(datetime) {
            const year = datetime.substr(0, 4);
            const month = datetime.substr(4, 2);
            const day = datetime.substr(6, 2);
            let hour = parseInt(datetime.substr(8, 2));
            const min = datetime.substr(10, 2);
            const period = hour >= 12 ? "PM" : "AM";

            if (hour > 12) hour -= 12;
            if (hour === 0) hour = 12;

            return `${year}년 ${month}월 ${day}일 ${hour}:${min} ${period}`;
        }

        function congestionLevelText(congestionLevel) {
            switch (congestionLevel) {
                case 1: return "여유";
                case 2: return "보통";
                case 3: return "혼잡";
                case 4: return "매우 혼잡";
                default: return "알 수 없음";
            }
        }

        function statusLevelText(congestionLevel) {
            switch (congestionLevel) {
                case 1: return "안전합니다";
                case 2: return "보통입니다";
                case 3: return "주의하세요";
                case 4: return "위험합니다";
                default: return "알 수 없음";
            }
        }
    </script>
</body>
</html>
